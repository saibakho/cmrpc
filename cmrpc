#!/usr/bin/env python

import os, sys, time, subprocess
from pypresence import Presence
import pyimgur

import json
def print_dict(data):
	print(json.dumps(data, indent=4, sort_keys=True, ensure_ascii=False))

class RPC:
	def __init__(self, rpc_id, imgur_id, cover_dir):
		self.cover_dir = os.path.expanduser(cover_dir)
		self.imgur = pyimgur.Imgur(imgur_id)
		self.rpc = Presence(rpc_id)
		self.saved_imgs = {}

	def start(self):
		while True:
			try:
				subprocess.check_output(["pgrep", "cmus"])
				break
			except:
				print("[ERROR] No cmus server found. Exit.")
				time.sleep(1)
		try:
			cur_song = ""
			status = {
				"playing": False,
				"elapsed_time": 0
			}
			self.rpc.connect()
			print("[OK] RPC started.")

			while True:
				time.sleep(1)
				try:
					status = self.get_status()
					if not status["playing"]:
						self.rpc.clear()
						cur_song = ""
						continue
				except:
					print("[ERROR] No cmus server found. Exit.")
					return
				if cur_song != status["title"]:
					cur_song = status["title"]

					cover_hash, cover_path = self.extract_cover(status)
					self.notify(status, cover_path)
					print("[OK] Status: ", end="")
					print_dict(status)

					self.rpc.update(
						large_image=self.upload_cover(status, cover_hash),
						small_image="play-black",
						large_text=status["album"],
						small_text=status["length"],
						details="%s"%status["title"],
						state="%s"%status["artist"],
						start=time.time()-status["elapsed_time"]
					)
		finally:
			self.rpc.close()
			print("[OK] RPC closed.")
			
			os.system("rm -rf %s"%self.cover_dir)
			print("[OK] Temp cover folder deleted.")

			for _, img in self.saved_imgs.items():
				img.delete()
				print("[OK] %s deleted."%img.link)
			print("[OK] img from Imgur deleted.")
		#	icons source:
		#	https://www.flaticon.com/free-icon/pause_709691
		#	https://www.flaticon.com/free-icon/play-button_109197

	def get_status(self):
		ret = {}
		for line in subprocess.check_output(["cmus-remote", "-C", "status"]).decode("utf-8").split("\n"):
			params = line.split(" ")
			if params == []:
				continue
			match params[0]:
				case "status":
					ret["playing"] = params[1] == "playing"
				case "file":
					ret["file"] = " ".join(params[1:])
				case "duration":
					num = int(params[1])
					ret["length"] = "%s%02d : %02d"%("%02d : "%(
						num/3600) if num > 3600 else "", (num/60)%60, num%60)
				case "position":
					ret["elapsed_time"] = int(params[1])
				case "tag":
					ret[params[1]] = " ".join(params[2:])
					# failed when only one char (?)
					if len(ret[params[1]]) < 2:
						ret[params[1]] += " "
		return ret

	def notify(self, status, cover_path):
		if not os.path.exists(cover_path):
			cover_path = os.path.dirname(__file__)+"/captivate.jpg"
		os.system("notify-send -i %s 'Title : %s\nArtist : %s\nAlbum : %s\nLength : %s'"%
			(cover_path, status["title"].replace("'", "'\\''"),
						 status["artist"].replace("'", "'\\''"), 
						 status["album"].replace("'", "'\\''"), status["length"]))

	def extract_cover(self, status):
		cover_hash = hash(status["album"].replace(" ", ""))
		cover_path = "%s/%s.jpg"%(self.cover_dir, cover_hash)
		filename = status["file"].replace("'", "'\\''")
		if not os.path.exists(cover_path):
			os.system("mkdir -p %s"%cover_dir)
			os.system("ffmpeg -i '%s' -an -vcodec copy %s 2>/dev/null"%(filename, cover_path))
		return cover_hash, cover_path

	def upload_cover(self, status, cover_hash):
		if cover_hash in self.saved_imgs:
			return self.saved_imgs[cover_hash].link
		try:
			cover_path = "%s/%s.jpg"%(self.cover_dir, cover_hash)
			result = self.imgur.upload_image(cover_path, title=status["album"])
			self.saved_imgs[cover_hash] = result
			print("[OK] Cover URL:", result.link)
			return result.link
		except:
			print("[ERROR] Upload to Imgur failed.")
		return "captivate"

if __name__ == "__main__":
	# you can use your own IDs
	rpc_id = "989349655831785523"
	imgur_id = "9208169c5394267"
	cover_dir = "~/.config/cmus/covers"
	RPC(rpc_id, imgur_id, cover_dir).start()

	# ==> todos:
	# 1. jp2a visualizer